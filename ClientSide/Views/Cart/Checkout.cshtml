@model ClientSide.ViewModels.CheckoutViewModel

@{
    ViewData["Title"] = "Thanh toán Đơn hàng";
}

<div class="container" style="padding: 50px;">
    <h2>Xác nhận Thanh toán</h2>
    <hr />

    <div class="row">
        <div class="col-md-7">
            <h4>Thông tin đơn hàng</h4>
            <p><strong>Khách hàng:</strong> @Model.CustomerName</p>
            <p><strong>Địa chỉ giao hàng:</strong> @Model.ShippingAddress</p>
            <p><strong>Số điện thoại:</strong> @Model.PhoneNumber</p>

            <h5>Chi tiết sản phẩm</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>Sản phẩm</th>
                        <th>Số lượng</th>
                        <th>Giá</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.CartItems)
                    {
                        <tr>
                            <td>@item.ProductName</td>
                            <td>@item.Quantity</td>
                            <td>@((item.Price * item.Quantity).ToString("N0")) VND</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="col-md-5">
            <div class="card p-3">
                <h4>Tổng cộng</h4>
                <h2 class="text-danger">@Model.TotalAmount.ToString("N0") VND</h2>
                <hr />
                <p>Chọn phương thức thanh toán:</p>

                <button id="btnVnPay" class="btn btn-primary w-100">
                    Thanh toán VNPay
                </button>

                <a asp-action="PlaceOrderCOD" asp-controller="Cart" class="btn btn-secondary w-100 mt-2">
                    Thanh toán khi nhận hàng (COD)
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {

            var btnVnPay = document.getElementById("btnVnPay");

            if (btnVnPay) {
                btnVnPay.onclick = function(e) {
                    e.preventDefault();

                    var orderId = @Model.OrderId;
                    var totalAmount = @Model.TotalAmount;

                    fetch('/Payment/Checkout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'orderId=' + orderId + '&totalAmount=' + totalAmount
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.paymentUrl) {
                            window.location.href = data.paymentUrl;
                        } else {
                            alert("Lỗi: Không thể tạo URL thanh toán.");
                        }
                    })
                    .catch(error => {
                        console.error("Lỗi khi gọi /Payment/Checkout:", error);
                        alert("Đã xảy ra lỗi. Vui lòng thử lại.");
                    });
                };
            }
        });
    </script>
}